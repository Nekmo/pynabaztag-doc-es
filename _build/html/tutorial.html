

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tutorial: Creación de un plugin &mdash; PyNabaztag v2.7 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="top" title="PyNabaztag v2.7 documentation" href="index.html" />
    <link rel="prev" title="Introducción: Qué es PyNabaztag" href="intro.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="intro.html" title="Introducción: Qué es PyNabaztag"
             accesskey="P">anterior</a> |</li>
        <li><a href="index.html">PyNabaztag v2.7 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="tutorial-creacion-de-un-plugin">
<h1>Tutorial: Creación de un plugin<a class="headerlink" href="#tutorial-creacion-de-un-plugin" title="Enlazar permanentemente con este título">¶</a></h1>
<p>Uno de los objetivos de PyNabaztag, es la modularidad. Toda capacidad añadida al servidor, debería de ser fácilmente activable y desactivable sin que ello requiera modificación alguna de código. Ello permite mayor personalización y encontrar más fácilmente errores.</p>
<p>En el siguiente tutorial se expondrá cómo crear un plugin que cumpla las siguientes características:</p>
<ol class="arabic simple">
<li>El plugin sólo se activará y funcionará si el usuario lo desea.</li>
<li>Nabaztag hablará al recibir un evento (pulsación de botón, objeto RFID...).</li>
<li>Dicho evento deberá poder ser configurado por el usuario.</li>
<li>El evento podrá ser reestablecido.</li>
<li>Habrá un texto por defecto que será dicho, el cual será &#8220;Hola Mundo&#8221;. Dicho texto podrá ser cambiado por el usuario, sin afectar a los demás usuarios del servidor.</li>
<li>Las funcionalidades del plugin deberán poder ser desactivadas por el usuario para sí mismo, borrando datos de su presencia.</li>
<li>El plugin se llamará &#8220;saythis&#8221;.</li>
</ol>
<div class="section" id="crear-un-plugin-nuevo">
<h2>1. Crear un plugin nuevo<a class="headerlink" href="#crear-un-plugin-nuevo" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Lo primero de todo, crearemos un archivo en el directorio <strong>pynabaztag/plugins/</strong> llamado <strong>saythis.py</strong>, y pegaremos la siguiente plantilla que nos guiará en la creación de nuestro plugin.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># from threading import Timer ## Tareas que se ejecutarán en X tiempo.</span>
<span class="c"># import gettext ## Locales</span>
<span class="c"># from .. blocks import Packet, MessageBlock ## Comunicación S-&gt;C.</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">base</span>

<span class="c"># Diccionario con configuraciones por defecto</span>
<span class="n">DEFAULT_CFG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c"># &#39;rabbids&#39;: {}, ## configuraciones en cada conejo.</span>
<span class="p">}</span>

<span class="c"># Descomentar la siguiente línea para las locales</span>
<span class="c"># _ = gettext.gettext ## Traducir texto mediante _(&quot;Texto&quot;)</span>

<span class="k">class</span> <span class="nc">Pluginname</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">plugin_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Se ejecutará justo en el momento de importarse el plugin. Úsese</span>
        <span class="c"># solo para aquellos casos en que este plugin sirva de biblioteca</span>
        <span class="c"># para otros plugins.</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">post_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Se ejecutará tras haberse ejecutado todos los demás plugins. Si</span>
        <span class="c"># su plugin va a usar otro plugin de biblioteca (por ejemplo, el</span>
        <span class="c"># plugin events), ponga aquí aquellas cosas que le hagan uso. De</span>
        <span class="c"># lo contrario puede provocarse una excepción, ya que si se pone</span>
        <span class="c"># en plugin_init, el plugin events podría no haberse importado</span>
        <span class="c"># todavía.</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">web_user_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hconn</span><span class="p">):</span>
        <span class="c"># Página de configuración del plugin</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">enable_rabbid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hconn</span><span class="p">):</span>
        <span class="c"># El Nabaztag ha sido activado a través de la página de plugins</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">disable_rabbid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hconn</span><span class="p">):</span>
        <span class="c"># El Nabaztag fue desactivado en la lista de plugins.</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>La clase &#8220;Pluginname&#8221; será la que se instancie, y será donde trabajemos en nuestro plugin. El nombre de la clase deberá ser el mismo que el del plugin, pero con la primera letra mayúscula. En nuestro caso:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Saythis</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">plugin_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Se ejecutará justo en el momento de importarse el plugin. Úsese</span>
        <span class="c"># solo para aquellos casos en que este plugin sirva de biblioteca</span>
        <span class="c"># para otros plugins.</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>Finalizado esto, haremos que en la próxima ejecución de PyNabaztag el plugin que acabamos de crear se importe. Para ello modificaremos el archivo <strong>pynabaztag/plugins/__init__.py</strong> añadiendo el nombre del fichero del plugin::</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;events&#39;</span><span class="p">,</span> <span class="s">&#39;taichi&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">...</span><span class="p">),</span> <span class="s">&#39;saythis&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">En futuras versiones de PyNabaztag, el anterior paso puede no ser necesario, siendo sustituido por una página de administración para gestionar los plugins activos.</p>
</div>
</div>
<div class="section" id="secciones-de-nuestro-nuevo-plugin">
<h2>2. Secciones de nuestro nuevo plugin<a class="headerlink" href="#secciones-de-nuestro-nuevo-plugin" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Ya tenemos una plantilla de lo que será nuestro futuro plugin, pero antes de empezar a programar, es necesario comprender el uso que tendrá cada sección del código.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">plugin_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># Se ejecutará justo en el momento de importarse el plugin. Úsese</span>
    <span class="c"># solo para aquellos casos en que este plugin sirva de biblioteca</span>
    <span class="c"># para otros plugins.</span>
    <span class="k">pass</span>
<span class="k">def</span> <span class="nf">post_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># Se ejecutará tras haberse ejecutado todos los demás plugins. Si</span>
    <span class="c"># su plugin va a usar otro plugin de biblioteca (por ejemplo, el</span>
    <span class="c"># plugin events), ponga aquí aquellas cosas que le hagan uso. De</span>
    <span class="c"># lo contrario puede provocarse una excepción, ya que si se pone</span>
    <span class="c"># en plugin_init, el plugin events podría no haberse importado</span>
    <span class="c"># todavía.</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Ambos métodos se ejecutarán en el inicio del plugin, pero la primera se ejecutará cuando los plugins aún se están importando, y la segunda cuando todos los plugins ya se han importado. En el uso general, se debe usar la segunda. La primera solo deberá usarse en casos específicos, cuando se vaya a crear algo de lo que haga uso otros plugins.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">web_user_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hconn</span><span class="p">):</span>
    <span class="c"># Página de configuración del plugin</span>
    <span class="k">pass</span>
<span class="k">def</span> <span class="nf">enable_rabbid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hconn</span><span class="p">):</span>
    <span class="c"># El Nabaztag ha sido activado a través de la página de plugins</span>
    <span class="k">pass</span>
<span class="k">def</span> <span class="nf">disable_rabbid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hconn</span><span class="p">):</span>
    <span class="c"># El Nabaztag fue desactivado en la lista de plugins.</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Las 3 se encuentran relacionadas con la página de gestión del plugin a través de la web de PyNabaztag. En el caso de la primera, se mostrará la página de configuración y uso del plugin. La segunda cuando el plugin se ha habilitado por el usuario, y la tercera cuando se ha deshabilitado. Es importante remarcar, que en las 3, estaremos trabajando destinados a 1 conejo. Esto quiere decir, que mientras que en los métodos de init estábamos haciendo cosas destinadas a todos los Nabaztag que usen el plugin, en estas 3 lo haremos con 1 conejo en específico.</p>
</div>
<div class="section" id="habilitar-el-plugin-configuracion-inicial-y-traduccion">
<h2>3. Habilitar el plugin, configuración inicial y traducción<a class="headerlink" href="#habilitar-el-plugin-configuracion-inicial-y-traduccion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En nuestro plugin, establecíamos que por defecto, el texto a decir por Nabaztag cuando recibía un evento, debía ser &#8220;Hola mundo&#8221;. Esto texto lo estableceremos como una configuración que estableceremos justo al habilitarse el plugin en la lista de plugins en la página de configuración. Ahora, surje el siguiente problema, ¿cómo almacenar configuraciones? PyNabaztag trae una solución para ello, que consiste en un diccionario individual por cada plugin, accesible mediante::</p>
<div class="highlight-python"><div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</pre></div>
</div>
<p>Y aquí es donde entra en juego <em>DEFAULT_CFG</em>, que será el contenido por defecto de dicho diccionario al importarse el plugin por primera vez. Guardaremos las configuraciones por cada conejo de manera que sean accesibles de la siguiente forma::</p>
<div class="highlight-python"><pre>self.cfg['rabbids'][&lt;id del conejo&gt;]</pre>
</div>
<p>Para que &#8220;rabbids&#8221; sea un diccionario que almacene configuraciones de los conejos, descomentaremos &#8220;rabbids&#8221; en <em>DEFAULT_CFG</em>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Diccionario con configuraciones por defecto</span>
<span class="n">DEFAULT_CFG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;rabbids&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="c"># configuraciones en cada conejo.</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Advertencia</p>
<p class="last">Tras haberse modificado el DEFAULT_CFG, debe tenerse en cuenta que si el plugin ya fue iniciado por primera vez, no se crearán las nuevas cosas que hayan añadido al DEFAULT_CFG. Deberemos borrar la configuración ya creada para que se vuelva a crear, con las nuevas cosas por defecto que se hayan añadido. El archivo de configuración se encontrará en <em>~/.config/pynabaztag/plugins/saythis.json</em>.</p>
</div>
<p>Ya tenemos una base para lo que serán nuestras configuraciones para todos los conejos que usen el plugin. Ahora, la pregunta es, <em>¿cuál es esa &#8220;id del conejo&#8221; y cómo se consigue?</em> En el argumentos &#8220;hconn&#8221;, tenemos un método llamado <strong>hconn.rabbid</strong>, el cual es un objeto Rabbid con varias cosas interesantes para trabajar con el Nabaztag en cuestión (aunque esto será otra historia... :) ). El problema, es que el objeto Rabbid no puede ser la clave del diccionario. Pero no debemos preocuparnos, porque el objeto Rabbid (cada objeto Rabbid es específico de un Nabaztag) nos ofrecerá un número de identificación mediante:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">str</span><span class="p">(</span><span class="n">hconn</span><span class="o">.</span><span class="n">rabbid</span><span class="p">)</span>
</pre></div>
</div>
<p>Dicha identificación será el número de dirección MAC del Nabaztag, el cual se puede consultar en la base. Cada MAC es única y específica para un Nabaztag.</p>
<div class="admonition tip">
<p class="first admonition-title">Truco</p>
<p class="last"><strong>Rabbid</strong> es la unión de los nombres <strong>Rabbit + IDentification</strong>. Es decir, &#8220;Identificación del Conejo&#8221;.</p>
</div>
<p>El siguiente código sería una solución al problema planteado:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">enable_rabbid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hconn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; \</span>
<span class="sd">    Crear la configuración inicial para el Nabaztag al activar el plugin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Creamos un diccionario como valor a la clave del conejo,</span>
    <span class="c"># que almacene las configuraciones para el conejo</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">hconn</span><span class="o">.</span><span class="n">rabbid</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c"># Texto a decir por defecto en el nombre de clave &quot;to_say&quot;.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">hconn</span><span class="o">.</span><span class="n">rabbid</span><span class="p">)][</span><span class="s">&#39;to_say&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Hola Mundo&#39;</span>
    <span class="c"># Lo siguiente guardará la configuración en el archivo</span>
    <span class="c"># de configuración, para que no se pierda. Sería algo</span>
    <span class="c"># así como un commit</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
</pre></div>
</div>
<p>Como se puede leer en el código fuente, tras hacer cambios ne la configuración, es necesario hacer al final lo siguiente para que se guarde en el archivo de configuración:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
</pre></div>
</div>
<p>Algo que no se ha planteado como un requisito, pero que sería recomendable, es permitir la localización (traducción a otros idiomas) de nuestro plugin. De esta manera, el texto por defecto se encontrará en su propio idioma. Para habilitar la localización, descomentaremos lo siguiente:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">gettext</span> <span class="c"># Locales</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="c"># Descomentar la siguiente línea para las locales</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">gettext</span><span class="o">.</span><span class="n">gettext</span> <span class="c"># Traducir texto mediante _(&quot;Texto&quot;)</span>
</pre></div>
</div>
<p>Y modificaremos la línea donde se establece el texto por defecto como se muestra aquí:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">enable_rabbid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hconn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; \</span>
<span class="sd">    Crear la configuración inicial para el Nabaztag al activar el plugin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Creamos un diccionario como valor a la clave del conejo,</span>
    <span class="c"># que almacene las configuraciones para el conejo</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">hconn</span><span class="o">.</span><span class="n">rabbid</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c"># Texto a decir por defecto en el nombre de clave &quot;to_say&quot;.</span>
    <span class="c"># Será traducido al idioma del usuario con el _(...)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">hconn</span><span class="o">.</span><span class="n">rabbid</span><span class="p">)][</span><span class="s">&#39;to_say&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Hola Mundo&#39;</span><span class="p">)</span>
    <span class="c"># Lo siguiente guardará la configuración en el archivo</span>
    <span class="c"># de configuración, para que no se pierda. Sería algo</span>
    <span class="c"># así como un commit</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="formulario-de-configuracion-y-uso">
<h2>4. Formulario de configuración y uso<a class="headerlink" href="#formulario-de-configuracion-y-uso" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Uno de los puntos más notables de PyNabaztag es, su framework para creación de formularios de configuración. En sólo unas pocas líneas, es posible crear un formulario que recoja unos datos, los verifique en el lado del cliente, los valide en el lado del servidor y se guarden en la configuración. Los formularios se componen de 3 partes fundamentes: Una primera donde se crea el formulario, una segunda donde se definen los campos, y una tercera donde se hará lo necesario tras tener los datos dados por el usuario.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">web_user_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hconn</span><span class="p">):</span>
    <span class="c"># Diccionario con la configuración del conejo</span>
    <span class="n">rabbid_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s">&#39;rabbids&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">hconn</span><span class="o">.</span><span class="n">rabbid</span><span class="p">)]</span>
    <span class="c"># Se crea el objeto formulario. El segundo argumento será un</span>
    <span class="c"># diccionario sobre el que se guarden los valores devueltos por</span>
    <span class="c"># el usuario en los campos. El atributo title será el título que</span>
    <span class="c"># encabece el formulario.</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">Form</span><span class="p">(</span><span class="n">hconn</span><span class="p">,</span> <span class="n">rabbid_cfg</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;Texto a decir&#39;</span><span class="p">)</span>
    <span class="c"># ... Se establecen los campos del formulario aquí ...</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">no_data</span><span class="p">():</span> <span class="k">return</span> <span class="n">form</span>
    <span class="c"># ... A partir de aquí, se poseen los valores devueltos por el usuario. ...</span>
</pre></div>
</div>
<p>Recordemos las configuraciones que necesitaremos poder parametrar:
# El texto a decir por el conejo
# Los eventos que activarán la función &#8220;decir el texto&#8221;.</p>
<p>Para ambas cosas, hay campos en el formulario que nos posibilitarán hacer esto muy fácilmente.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Campo del formulario to_say. El primer argumento es la clave en el</span>
<span class="c"># diccionario rabbid_cfg. La segunda el texto de ayuda del campo.</span>
<span class="n">form</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s">&#39;to_say&#39;</span><span class="p">,</span> <span class="s">&#39;Texto a decir&#39;</span><span class="p">)</span>
<span class="c"># Campo del formulario para seleccionar los eventos. El primer argumento</span>
<span class="c"># Es la función que se ejecutará al recibirse el evento.</span>
<span class="n">form</span><span class="o">.</span><span class="n">events</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">say_text</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Al usar los formularios no debe preocuparse de la localización. Aquellos argumentos que se considere que son de ayuda y visibles al usuario, se traducirán.</p>
</div>
<p>Antes que nada, avisar de que hemos definido una función que se ejecutará al recibirse el evento llamada <em>self.say_text</em>, como se puede ver en el código.</p>
<p>En este ejemplo, solo hemos usado una pequeña parte de las posibilidades que nos ofrecen los campos del Framework para Formularios de PyNabaztag. Hay más posibilidades que se irán ampliando, para facilitar la programación. Llegados a este punto, pueden surjir ciertas dudas: <em>¿qué pasa si el usuario no rellena el campo? ¿Se mostrará en el campo el valor que se colocó la última vez?</em>  A la primera pregunta, es necesario saber que el campo text obligará a rellenar el campo. Si no se rellena, saltará un aviso. Para desactivar esto, añada el argumento <em>req=False</em>. A la segunda pregunta, el campo pondrá el texto rellenado por última vez, sacándolo de rabbid_cfg. Esto se puede impedir con el argumento <em>default=&#8217;texto a poner&#8217;</em>.</p>
<p>PyNabaztag se encargará, como ya hemos dicho, de guardar las configuraciones en el diccionario de configuración den conejo. Lo único que tendremos que hacer será añadir al final, en la tercera sección del formulario, que se graben los datos aportados en el archivo de configuración.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># ... A partir de aquí, se poseen los valores devueltos por el usuario. ...</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
</pre></div>
</div>
<p>El resultado final sería el siguiente:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">web_user_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hconn</span><span class="p">):</span>
    <span class="c"># Diccionario con la configuración del conejo</span>
    <span class="n">rabbid_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s">&#39;rabbids&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">hconn</span><span class="o">.</span><span class="n">rabbid</span><span class="p">)]</span>
    <span class="c"># Se crea el objeto formulario. El segundo argumento será un</span>
    <span class="c"># diccionario sobre el que se guarden los valores devueltos por</span>
    <span class="c"># el usuario en los campos. El atributo title será el título que</span>
    <span class="c"># encabece el formulario.</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">Form</span><span class="p">(</span><span class="n">hconn</span><span class="p">,</span> <span class="n">rabbid_cfg</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;Texto a decir&#39;</span><span class="p">)</span>
    <span class="c"># ... Se establecen los campos del formulario aquí ...</span>
    <span class="c"># Campo del formulario to_say. El primer argumento es la clave en el</span>
    <span class="c"># diccionario rabbid_cfg. La segunda el texto de ayuda del campo.</span>
    <span class="n">form</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s">&#39;to_say&#39;</span><span class="p">,</span> <span class="s">&#39;Texto a decir&#39;</span><span class="p">)</span>
    <span class="c"># Campo del formulario para seleccionar los eventos. El primer argumento</span>
    <span class="c"># Es la función que se ejecutará al recibirse el evento.</span>
    <span class="n">form</span><span class="o">.</span><span class="n">events</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">say_text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">no_data</span><span class="p">():</span> <span class="k">return</span> <span class="n">form</span>
    <span class="c"># ... A partir de aquí, se poseen los valores devueltos por el usuario. ...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
</pre></div>
</div>
<p>Esto generará un formulario con 2 campos: Un campo de texto para introducir el texto, y un cuadro de selección múltiple para elegir los eventos.</p>
</div>
<div class="section" id="comunicacion-servidor-cliente">
<h2>5. Comunicación Servidor -&gt; Cliente<a class="headerlink" href="#comunicacion-servidor-cliente" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Recapitulemos lo que llevamos hasta el momento: Hemos creado un plugin llamado &#8220;saythis&#8221;, el cual puede activar el usuario a través de la interfaz web, y parametrar un texto que dirá Nabazag al recibir un evento (o varios), lo cual también es parametrable a través de la página web. Ahora, nos queda que al recibir el susodicho evento, se ejecute algo que haga que Nabaztag hable. Dicha función la hemos llamado en el apartado anterior como &#8220;say_text&#8221;. Crearemos un nuevo método en el plugin con dicho nombre:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">say_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rabbid</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Hablar a través del Nabaztag facilitado.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>El sistema de eventos ejecutará este método entregando 2 argumentos: un primero con un objeto Rabbid, el cual será como el ya conocido <em>&#8220;hconn.rabbid&#8221;</em>. Lo siguiente que nos queda por saber, es cómo haremos las comunicaciones entre nuestro servidor, y el Nabaztag en cuestión. Aquí es donde entran los denominados <strong>Paquetes&#8221; y &#8220;Bloques</strong>. Para la comunicación Servidor -&gt; Cliente, se usan bloques de instrucciones, y el paquete es un conjunto de uno o más bloques que se enviarán al Nabaztag. Existen 2 tipos diferentes de bloques: aquellos que tendrán consecuencias a largo plazo en el Nabaztag (como el bloque Reboot, que reiniciará a Nabaztag, o los &#8220;bloques ambiente&#8221;, que graban datos en la memoria de Nabaztag), y los &#8220;inmediatos&#8221; y sin consecuencias a largo plazo. Estos últimos serán los más utilizados, y controlarán cosas como la reproducción de sonidos, mover las orejas o los leds. En realidad, hay un único bloque que hace esto, llamado <strong>MessageBlock</strong>, pero que a su vez tiene en su interior una serie de &#8220;sub-bloques&#8221; con las instrucciones.</p>
<p>Para usar el bloque MessageBlock y Packet, descomentaremos:</p>
<div class="highlight-python"><pre>from .. blocks import Packet, MessageBlock # Comunicación S-&gt;C.</pre>
</div>
<p>Aunque Nabaztag no permita de por sí la sintetización de voz, MessageBlock tiene un sub-bloque que creará un archivo de audio con una voz sintetizada con el texto que le digamos, y pondrá la orden de reproducir dicho archivo en el MessageBlock. Este <em>&#8220;sub-bloque&#8221;</em>, se creará en el MessageBlock con el método <strong>say</strong>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Se instancia MessageBlock</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">MessageBlock</span><span class="p">()</span>
<span class="n">msg</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s">&quot;Texto a decir&quot;</span><span class="p">)</span>
<span class="c"># Si quisiéramos que se dijese otro texto justo después:</span>
<span class="c"># msg.say(&quot;Segundo texto que se dirá a continuación.&quot;)</span>
</pre></div>
</div>
<p>MessageBlock tiene además una solución para reducir esto en una sola línea (para cuando queremos poner sólo una instrucción en el MessageBlock. Aplicado a lo que necesitamos, sería:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Texto a decir obtenido de las configuraciones</span>
<span class="n">to_say</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s">&#39;rabbids&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">rabbid</span><span class="p">)][</span><span class="s">&#39;to_say&#39;</span><span class="p">]</span>
<span class="c"># MessageBlock sólo con la instrucción de decir el texto</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">MessageBlock</span><span class="p">(</span><span class="s">&#39;say&#39;</span><span class="p">,</span> <span class="n">to_say</span><span class="p">)</span>
</pre></div>
</div>
<p>Ahora, sólo nos queda añadir el bloque MessageBlock al Packet:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">say_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rabbid</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Hablar a través del Nabaztag facilitado.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Texto a decir obtenido de las configuraciones</span>
    <span class="n">to_say</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s">&#39;rabbids&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">rabbid</span><span class="p">)][</span><span class="s">&#39;to_say&#39;</span><span class="p">]</span>
    <span class="c"># Paquete con el conejo al que se enviará (rabbid) y el bloque</span>
    <span class="c"># MessageBlock que se enviará al conejo con el texto que se dirá</span>
    <span class="n">Packet</span><span class="p">(</span><span class="n">MessageBlock</span><span class="p">(</span><span class="s">&#39;say&#39;</span><span class="p">,</span> <span class="n">to_say</span><span class="p">))</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">rabbid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>En 2 sencillas líneas, hemos hecho que nuestro Nabaztag hable. ¿Sencillo, no? Es necesario decir, que si queremos que el Packet tenga más de 1 Block, el primer argumento deberá ser una tupla o un listado con los bloques. Los bloques, serán reproducidos a continuación. Hay más bloques y opciones, pero esto es todo lo que necesitamos saber en este tutorial.</p>
</div>
<div class="section" id="borrar-datos-al-deshabilitar-el-plugin">
<h2>6. Borrar datos al deshabilitar el plugin<a class="headerlink" href="#borrar-datos-al-deshabilitar-el-plugin" title="Enlazar permanentemente con este título">¶</a></h2>
<p>¡Genial! Ya tenemos nuestro plugin, y nuestro Nabaztag ya habla al recibir un evento. Pero no cantemos victoria tan rápido: aún tenemos que pensar en la deshabilitación de nuestro plugin. Aunque el plugin se desactive ahora mismo, Nabaztag seguirá hablando cuando reciba el evento, y no es lo que deseamos. Tenemos que:</p>
<p># Eliminar los eventos que activan la función
# Borrar los datos de configuración del usuario.</p>
<p>Para lo primero usaremos un método que nos trae el plugin Events:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">disable_rabbid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hconn</span><span class="p">):</span>
    <span class="c"># El Nabaztag fue desactivado en la lista de plugins.</span>
    <span class="c"># Eliminar todos los eventos que apuntan a la función para el conejo</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rm_recv_by_funct_event</span><span class="p">(</span><span class="n">hconn</span><span class="o">.</span><span class="n">rabbid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">say_text</span><span class="p">)</span>
</pre></div>
</div>
<p>Y después borraremos todos los datos de configuración:</p>
<blockquote>
<div>del self.cfg[&#8216;rabbids&#8217;][str(hconn.rabbid)]</div></blockquote>
<p>El resultado final sería como el siguiente:</p>
<blockquote>
<div><dl class="docutils">
<dt>def disable_rabbid(self, hconn):</dt>
<dd># El Nabaztag fue desactivado en la lista de plugins.
# Eliminar todos los eventos que apuntan a la función para el conejo
self.rm_recv_by_funct_event(hconn.rabbid, self.say_text)
# Se borran todas las configuraciones para el conejo
del self.cfg[&#8216;rabbids&#8217;][str(hconn.rabbid)]
# Se escribe en la configuración los cambios en realizados
self.cfg.write()</dd>
</dl>
</div></blockquote>
<p>Ya tenemos terminado nuestro plugin, y así quedaría el resultado:</p>
<div class="highlight-python"><pre># -*- coding: utf-8 -*-
from threading import Timer # Tareas que se ejecutarán en X tiempo.
import gettext # Locales
from .. blocks import Packet, MessageBlock # Comunicación S-&gt;C.
from . import base

# Diccionario con configuraciones por defecto
DEFAULT_CFG = {
    'rabbids': {}, # configuraciones en cada conejo.
}

# Descomentar la siguiente línea para las locales
_ = gettext.gettext ## Traducir texto mediante _("Texto")

class Pluginname(base.Base):
    def plugin_init(self):
        # Se ejecutará justo en el momento de importarse el plugin. Úsese
        # solo para aquellos casos en que este plugin sirva de biblioteca
        # para otros plugins.
        pass
    def post_init(self):
        # Se ejecutará tras haberse ejecutado todos los demás plugins. Si
        # su plugin va a usar otro plugin de biblioteca (por ejemplo, el
        # plugin events), ponga aquí aquellas cosas que le hagan uso. De
        # lo contrario puede provocarse una excepción, ya que si se pone
        # en plugin_init, el plugin events podría no haberse importado
        # todavía.
        pass
    def web_user_options(self, hconn):
        # Página de configuración del plugin
        # Diccionario con la configuración del conejo
        rabbid_cfg = self.cfg['rabbids'][str(hconn.rabbid)]
        # Se crea el objeto formulario. El segundo argumento será un
        # diccionario sobre el que se guarden los valores devueltos por
        # el usuario en los campos. El atributo title será el título que
        # encabece el formulario.
        form = base.Form(hconn, rabbid_cfg, title='Texto a decir')
        # ... Se establecen los campos del formulario aquí ...
        # Campo del formulario to_say. El primer argumento es la clave en el
        # diccionario rabbid_cfg. La segunda el texto de ayuda del campo.
        form.text('to_say', 'Texto a decir')
        # Campo del formulario para seleccionar los eventos. El primer
        # argumento Es la función que se ejecutará al recibirse el evento.
        form.events(self.say_text)
        if form.no_data(): return form
        # A partir de aquí, se poseen los valores devueltos por el usuario.
        self.cfg.write()
    def say_text(self, rabbid, data):
        """\
        Hablar a través del Nabaztag facilitado.
        """
        # Texto a decir obtenido de las configuraciones
        to_say = self.cfg['rabbids'][str(rabbid)]['to_say']
        # Paquete con el conejo al que se enviará (rabbid) y el bloque
        # MessageBlock que se enviará al conejo con el texto que se dirá
        Packet(MessageBlock('say', to_say)).send(rabbid, self.main)
    def enable_rabbid(self, hconn):
        """ \
        Crear la configuración inicial para el Nabaztag al activar el
        plugin.
        """
        # Creamos un diccionario como valor a la clave del conejo,
        # que almacene las configuraciones para el conejo
        self.cfg[str(hconn.rabbid)] = {}
        # Texto a decir por defecto en el nombre de clave "to_say".
        # Será traducido al idioma del usuario con el _(...)
        self.cfg[str(hconn.rabbid)]['to_say'] = _('Hola Mundo')
        # Lo siguiente guardará la configuración en el archivo
        # de configuración, para que no se pierda. Sería algo
        # así como un commit
        self.cfg.write()
    def disable_rabbid(self, hconn):
        # El Nabaztag fue desactivado en la lista de plugins.
        # El Nabaztag fue desactivado en la lista de plugins.
        # Eliminar todos los eventos que apuntan a la función para el conejo
        self.rm_recv_by_funct_event(hconn.rabbid, self.say_text)
        # Se borran todas las configuraciones para el conejo
        del self.cfg['rabbids'][str(hconn.rabbid)]
        # Se escribe en la configuración los cambios en realizados
        self.cfg.write()</pre>
</div>
</div>
<div class="section" id="que-queda-ahora">
<h2>7. ¿Qué queda ahora?<a class="headerlink" href="#que-queda-ahora" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Esta guía sólo ha servido como un ligero aperitivo a lo que viene de verdad, pero esperamos que haya servido para que te hagas una ligera idea del funcionamiento del sistema de plugins de PyNabaztag. Aún queda mucho que aprender, porque aquí no se acaba la cosa: PyNabaztag te ofrece más campos de formulario para que eches a volar tu imaginación, te permite hacer cosas como que un campo de texto exija que el valor sea un número, o que tenga una longitud máxima o mínima. Puedes rediseñar la página del formulario con Javascript y CSS, crear nuevas páginas para la web, establecer eventos crond para que una acción se ejecute en la fecha que tú digas, crear y usar coreografías para que Nabaztag baile, entre otras muchas otras cosas... ¡Te esperamos!</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Contenidos</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tutorial: Creación de un plugin</a><ul>
<li><a class="reference internal" href="#crear-un-plugin-nuevo">1. Crear un plugin nuevo</a></li>
<li><a class="reference internal" href="#secciones-de-nuestro-nuevo-plugin">2. Secciones de nuestro nuevo plugin</a></li>
<li><a class="reference internal" href="#habilitar-el-plugin-configuracion-inicial-y-traduccion">3. Habilitar el plugin, configuración inicial y traducción</a></li>
<li><a class="reference internal" href="#formulario-de-configuracion-y-uso">4. Formulario de configuración y uso</a></li>
<li><a class="reference internal" href="#comunicacion-servidor-cliente">5. Comunicación Servidor -&gt; Cliente</a></li>
<li><a class="reference internal" href="#borrar-datos-al-deshabilitar-el-plugin">6. Borrar datos al deshabilitar el plugin</a></li>
<li><a class="reference internal" href="#que-queda-ahora">7. ¿Qué queda ahora?</a></li>
</ul>
</li>
</ul>

  <h4>Tema anterior</h4>
  <p class="topless"><a href="intro.html"
                        title="Capítulo anterior">Introducción: Qué es PyNabaztag</a></p>
  <h3>Esta página</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/tutorial.txt"
           rel="nofollow">Enseñar el código</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Búsqueda rápida</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Ir a" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="intro.html" title="Introducción: Qué es PyNabaztag"
             >anterior</a> |</li>
        <li><a href="index.html">PyNabaztag v2.7 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Nekmo.
      Creado con <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>